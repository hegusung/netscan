import uuid
import json
import requests
from utils.config import Config
from utils.output import Output
from utils.db import DB

class VulnCallback:

    @classmethod
    def init(self):
        self.callbacks = {}

    @classmethod
    def register(self, vuln_info):
        vuln_uuid = str(uuid.uuid4())

        self.callbacks[vuln_uuid] = vuln_info

        return vuln_uuid

    @classmethod
    def check(self, vuln_uuid):
        if vuln_uuid in self.callbacks:

            vuln_info = self.callbacks[vuln_uuid]
            Output.vuln({'target': vuln_info['url'], 'message': vuln_info['description']})

            DB.insert_vulnerability(vuln_info)

            del self.callbacks[vuln_uuid]

    @classmethod
    def new_vulnerability_check(self, vuln_info):
        srv_ip = Config.config.get("Server", "bind_ip")
        if srv_ip == "0.0.0.0":
            srv_ip = "127.0.0.1"
        srv_port = int(Config.config.get("Server", "http_port"))

        res = requests.post("http://%s:%d/register_callback/" % (srv_ip, srv_port), data=json.dumps(vuln_info)) 

        return res.text
